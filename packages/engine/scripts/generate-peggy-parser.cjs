#!/usr/bin/env node
/*
 * Generates the Peggy parser source from the grammar.
 * Output: packages/engine/src/parser/peggy/generated/parser.ts
 */

const fs = require('fs');
const path = require('path');
const peggy = require('peggy');

const root = path.resolve(__dirname, '..');
const grammarPath = path.join(root, 'src', 'parser', 'peggy', 'grammar.peggy');
const outPath = path.join(root, 'src', 'parser', 'peggy', 'generated', 'parser.ts');

function main() {
  const grammar = fs.readFileSync(grammarPath, 'utf8');
  const source = peggy.generate(grammar, {
    output: 'source',
    format: 'es',
    cache: true,
    allowedStartRules: ['Program'],
  });

  const banner = [
    '// @ts-nocheck',
    '// AUTO-GENERATED by packages/engine/scripts/generate-peggy-parser.cjs',
    '// DO NOT EDIT MANUALLY. Update grammar.peggy and re-run the generator.',
    '',
  ].join('\n');

  fs.mkdirSync(path.dirname(outPath), { recursive: true });
  fs.writeFileSync(outPath, `${banner}${source}\n`, 'utf8');
  console.log(`Peggy parser generated -> ${path.relative(process.cwd(), outPath)}`);
}

main();
